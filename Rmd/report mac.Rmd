---
output:
  word_document:
    reference_docx: ../report_template.dotx
mathjax: TRUE
---


```{r, knitr, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}
library(knitr)

knitr::opts_chunk$set(
               cache     =TRUE, 
               comment   ="", 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE, 
               eval      =TRUE,
               crop      =TRUE,
               cache.path="../cache/figs/cond/",
               fig.path  ="../tex/figs",
               fig.width =10,
               fig.height=8,
               dev       ="png")

rm(list=ls())

iFig=0
iTab=0

library(FLCore)    # install.packages("FLCore", repos="http://flr-project.org/R")
library(FLBRP)     # install.packages("FLBRP", repos="http://flr-project.org/R")
library(FLasher)   # install.packages("FLasher", repos="http://flr-project.org/R")
library(FLAssess)  # install.packages("FLAssess", repos="http://flr-project.org/R")
library(FLife)     # install.packages("FLife", repos="http://flr-project.org/R")
library(ggplotFL)

library(popbio)

library(GGally)
library(ggpubr)

library(rjson) # install.packages("rjson"); used for dropbox function
library(RJSONIO)

library(plyr)
library(dplyr)
library(reshape)

library(readxl)
  
library(mgcv)
library(mgcViz)

library(tidyverse)

theme_set(theme_bw(16))

library(captioner)     # captions
tab_nums <- captioner::captioner(prefix = "Table", levels=1, type=c("n"), infix=".")
fig_nums <- captioner::captioner(prefix = "Figure", levels=1, type=c("n"), infix=".")

source("../R/dd.R")
source("../R/pm.R")

source("../R/get_dropbox.r")
dropboxdir<-try(file.path(get_dropbox(), "pelagics"))

if ("try-error"%in%is(dropboxdir))
  dropboxdir="~/Dropbox/pelagics"


mystk     <- "mac"; mystkname <- "Northeast Atlantic mackerel"; mylatin <- "Scombrus scomber"
# mystk     <- "whb"; mystkname <- "Blue whiting";                mylatin <- "Micromesistius poutassou" 
maxyear <- 2050

load(file=file.path(dropboxdir,paste0("data/om/",mystk,"matPar.RData")))
 

# ------------------------------------------------------------------------------
# Operating model
# ------------------------------------------------------------------------------
figuresdir <- file.path(dropboxdir, "results", mystk, "figures")
tablesdir  <- file.path(dropboxdir, "results", mystk, "tables")


```

<!-- =============================================================================================================== -->
<!-- ## Mackerel report                                                                                              -->
<!-- =============================================================================================================== -->


**Evaluating impacts of Density Dependent processes on `r mystkname` via MSE simulations**


**L. Kell, M.A. Pastoors**

`r format(Sys.time(), '%d/%m/%Y')`

Commissioned by: University of Copenhagen (Henrik Sparholt)

**Executive summary**

[summary here]



<!-- =============================================================================================================== -->
<!-- Section 1: introduction                                                                                         -->
<!-- =============================================================================================================== -->

```{r}

# captioner::bump(fig_nums, level=1)
# fig_nums(name    = "section1_fig", caption = "section1_fig", level = 1, display = FALSE)
# tab_nums(name    = "section1_tab", caption = "section1_tab", level = 1, display = FALSE)

```

# Introduction

The purpose of this work is to support the project “Fmsy-project for six high profile fish stocks”. The project focuses on the current management approach for fish stocks based on single-species Fmsy Values where the only density-dependent process that is included is recruitment. The project includes three other density-dependent population dynamics: growth (weight at age), sexual maturity and natural mortality.  

This report deals with the evaluation of density dependent processes for `r mystkname` using Management Strategy Evaluation (MSE). Steps in the analysis:

1. Conditioning and summaries based on the 2022 ICES assessment (section 2)
2. Estimating Density Dependent effects based on equilibrium analyses and explore DD before setting up the OMs (section 3)
3. Setting up the Operating Models (OM) (section 4)
4. Running MSE's (section 5)

Four alternatives OMs have been included in the analyses: 

1. No density dependent processes
2. DD in growth
3. DD in growth and maturity
4. DD in growth, maturity and natural mortality

All MSE's have been developed within the FLR framework (https://flr-project.org/) and all the code is stored on github (https://github.com/martinpastoors/ddmse). 

All data and results are available on DropBox (https://www.dropbox.com/sh/k87x074xqw7sgae/AAAmF980iR2n24wTkqhOhnpfa?dl=0)

<!-- =============================================================================================================== -->
<!-- Section 2: conditioning and summaries of ICES assessment                                                        -->
<!-- =============================================================================================================== -->


# Conditioning and summaries based on the 2022 ICES assessment

```{r}

# fig_nums(name    = "section2_fig", caption = "section2_fig", level = 1, display = FALSE)
# tab_nums(name    = "section2_tab", caption = "section2_tab", level = 1, display = FALSE)

```

**Weight at age**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_waa", level = 1, display = FALSE,
  caption = paste0(mystkname, ". Weight at age by year and cohort"))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "waa.jpg", sep="_")))

```

_`r fig_nums("cond_waa")`_

\newpage

**Maturity at age**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_mat", level = 1, display = FALSE,
  caption = paste0(mystkname, ". Maturity at age by year and cohort"))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "mat.jpg", sep="_")))

```

_`r fig_nums("cond_mat")`_

\newpage


**Natural mortality at age (fixed)**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_natmor", level = 1, display = FALSE,
  caption = paste0(mystkname, ". Natural mortality at age by year and cohort (all ages and years the same M)"))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "m.jpg", sep="_")))

```

_`r fig_nums("cond_natmor")`_

\newpage


**Density dependence in Weight at age vs. Total biomass**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_ddwaa", level = 1, display = FALSE,
  caption = paste0(mystkname, ". Density dependence and weight at age."))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "dd_waa.jpg", sep="_")))

```

_`r fig_nums("cond_ddwaa")`_

\newpage

**GAMM at age**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_gammwaa", level = 1, display = FALSE,
  caption = paste0(mystkname, ". GAMM analysis of density dependence and weight at age."))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "gamm.jpg", sep="_")))

```

_`r fig_nums("cond_gammwaa")`_

\newpage

**GAMM summary**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

tab_nums(
  name    = "cond_gammsummary", level = 1, display = FALSE,
  caption = paste0(mystkname, ". GAMM summary of density dependence and weight at age."))

cat(readLines(file.path(tablesdir, paste(mystk, "gamm summary.txt", sep="_"))), sep = '\n')

```

_`r tab_nums("cond_gammsummary")`_

\newpage

**GAMM summary**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

tab_nums(
  name    = "cond_gammcoefficients", level = 1, display = FALSE,
  caption = paste0(mystkname, ". GAMM coefficients of density dependence and weight at age."))

cat(readLines(file.path(tablesdir, paste(mystk, "gamm coefficients.txt", sep="_"))), sep = '\n')

```

_`r tab_nums("cond_gammcoefficients")`_

\newpage


**LM of density dependence in weight at age**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_lmwaa", level = 1, display = FALSE,
  caption = paste0(mystkname, ". LM analysis of density dependence and weight at age."))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "lm_waa.jpg", sep="_")))

```

_`r fig_nums("cond_lmwaa")`_

\newpage

**LM summary**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

tab_nums(
  name    = "cond_lmsummary", level = 1, display = FALSE,
  caption = paste0(mystkname, ". LM summary of density dependence and weight at age."))

cat(readLines(file.path(tablesdir, paste(mystk, "lm summary.txt", sep="_"))), sep = '\n')

```

_`r tab_nums("cond_gammcoefficients")`_

\newpage

**DD analysis of maturity at age**

[text here]

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_ddmat", level = 1, display = FALSE,
  caption = paste0(mystkname, ". Analysis of density dependence and maturity at age."))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "dd_mat.jpg", sep="_")))

```

_`r fig_nums("cond_ddmat")`_

\newpage

**Estimated maturity at weight**

$f(x) = \frac{1}{1+e^{-k(x-x_0)}}$

Estimated parameters: k=`r matPar$par[1]` $W_{50}$=`r matPar$par[2]`

```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "cond_matogive", level = 1, display = FALSE,
  caption = paste0(mystkname, ". Estimated maturity ogive at weight"))

knitr::include_graphics(path=file.path(figuresdir, paste(mystk, "mat_ogive.jpg", sep="_")))

```

_`r fig_nums("cond_matogive")` _

 
<!-- =============================================================================================================== -->
<!-- Section 3: Estimating Density Dependent effects based on equilibrium analyses                                   -->
<!-- =============================================================================================================== -->

# Estimating Density Dependent effects based on equilibrium analyses


Life history parameters are used to develop an example of modelling density dependence for mass, maturity and natural mortality-at-age. The parameters are first used to construct An `FLBRP` object representing the equilibrium, and are then coerced into an `FLStock` to model the time series dynamics.

## Mass-at-age [SHOULD WE CALL IT WEIGHT AT AGE, SINCE WE ARE USING Wa? ]

Mass-at-age ($W_a$) is modelled as

$W_a = {\overline{W_a}} B^{{\beta}_a}$

Where $\overline{W_a}$ and $\beta$ are estimated from a regression of mass-at-age ($W_a$) on total biomass ($B_a$), based on empirical data. $W_a$ is constrained so sizes do not become unfeasible large or small.

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_dd_mass", level = 1, display = FALSE,
  caption = "Simulation of density dependence in mass-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_sim_dd_mass.jpg")))

```

_`r fig_nums("sim_dd_mass")`_

## Maturity-at-weight

Maturity is then  modelled as a logistic function of mass-at-age i.e.

$O(W_a) = 1/(1+e^{k(W_a-W_{50})})$

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_dd_mat", level = 1, display = FALSE,
  caption = "Simulation of density dependence in maturity-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_sim_dd_maturity.jpg")))

```

_`r fig_nums("sim_dd_mat")`_


## Natural mortality

Is assumed to vary at unit length ($L_1$) e.g.

$ln(M_1) =\alpha + \beta ln(L_{\infty}) + \gamma ln(k)$

where $\alpha=0.65$, $\beta=0.91$, $\gamma=0.87$

Length-at-age ($L_a$) can be obtained from the length-weight relationship

$L_a=(W/a)^{1/b}$

giving

$ln(M_1) =(W/a)^{1/b}(\alpha + \beta ln(L_{\infty}) + \gamma ln(k))$

For DD there is a relationship between Mass at age $M_a$ and total biomass ($B$)

Mackerel:

$M = 0.0232B + 0.0524$

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_dd_m", level = 1, display = FALSE,
  caption = "Simulation of density dependence in M-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_sim_dd_m.jpg")))

```

_`r fig_nums("sim_dd_m")`_

Comparison of equilibrium yield plots for simulation with and without density-dependent processes

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_yield", level = 1, display = FALSE,
  caption = "Simulation of density dependence in M-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_eq_yield.jpg")))

```

_`r fig_nums("sim_dd_m")`_



<!-- =============================================================================================================== -->
<!-- Section 4: Setting up the Operating Models (OM)                                                                 -->
<!-- =============================================================================================================== -->

# Setting up the Operating Models (OM)

**Stock assessments**

Stock assessments with SAM (non-DD), density-dependent SAM, VPA based on SAM (non-DD) and density-dependent VPA. The VPA reconstructions of the SAM assessment, shows a strongly divergent pattern in recruitment and also some differences in the trend of SSB. Mean fishing mortality is somewhat more variable in the VPA reconstruction compared to the SAM assessment. Density-dependent processes (on weight, maturity and M) tend to lead to lower SSB in the latter part of the time series. 


```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "om_assessments", level = 1, display = FALSE,
  caption = "Comparison of different assessments. VPA-M is used going forward")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_comparing_assessments.jpg")))

```

_`r fig_nums("om_VPADDM")`_

\newpage

**Density dependence in mass-at-age**

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "om_VPADDM", level = 1, display = FALSE,
  caption = "Simulation of density dependence in Mass-at-age")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_VPADDM_4panels.jpg")))

```

_`r fig_nums("om_VPADDM")`_

\newpage

**Density dependence in mass-at-age and maturity at age**

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "om_VPADDMM", level = 1, display = FALSE,
  caption = "Simulation of density dependence in Mass-at-age and Maturity at age")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_VPADDMM_4panels.jpg")))

```

_`r fig_nums("om_VPADDMM")`_

\newpage

**Density dependence in mass-at-age, maturity at age and M at age**

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "om_VPADDMMM", level = 1, display = FALSE,
  caption = "Simulation of density dependence in Mass-at-age, maturity at age and M at age")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_VPADDMMM_4panels.jpg")))

```

_`r fig_nums("om_VPADDMMM")`_

\newpage

**Comparison of equilibrium curves for density dependence analyses: biomass against yield**

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "om_eqyield", level = 1, display = FALSE,
  caption = "Equilibrium curves for density dependence analyses: biomass against yield")

knitr::include_graphics(path=file.path(figuresdir, paste0(mystk,"_comparing_dd.jpg")))

```

_`r fig_nums("om_eqyield")`_

\newpage



<!-- =============================================================================================================== -->
<!-- Section 5: Running forward projections                                                                          -->
<!-- =============================================================================================================== -->

# Forward projections without feedback

```{r, echo=FALSE, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}


```


<!-- =============================================================================================================== -->
<!-- Section 6: Discussion and conclusions                                                                           -->
<!-- =============================================================================================================== -->

# Discussion and conclusions

The quality shall live up to that demanded by the International Council for the Exploration of the Sea (ICES) and potentially be used in ICES advice to fisheries managers. The Consultant shall be interacting with the leadership of the project Henrik Sparholt, or his representative, in the process of developing the software. The software shall be made publicly available via Github or on alternative platform if so directed by Henrik Sparholt or his representative.

<!-- =============================================================================================================== -->
<!-- Funding                                                                                                         -->
<!-- =============================================================================================================== -->

# Funding




<!-- =============================================================================================================== -->
<!-- References                                                                                                      -->
<!-- =============================================================================================================== -->

# References





<!-- =============================================================================================================== -->
<!-- Annex 1: OM conditioning                                                                           -->
<!-- =============================================================================================================== -->

# Annex 1: OM conditioning



<!-- =============================================================================================================== -->
<!-- Annex 2: Density dependent processes                                                                           -->
<!-- =============================================================================================================== -->

# Annex 2: Density dependent processes



