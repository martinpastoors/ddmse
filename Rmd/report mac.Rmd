---
output:
  word_document:
    reference_docx: ../report_template.dotx
mathjax: TRUE
---


```{r, knitr, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}
library(knitr)

knitr::opts_chunk$set(
               cache     =TRUE, 
               comment   ="", 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE, 
               eval      =TRUE,
               crop      =TRUE,
               cache.path="../cache/figs/cond/",
               fig.path  ="../tex/figs",
               fig.width =10,
               fig.height=8,
               dev       ="png")

rm(list=ls())

iFig=0
iTab=0

library(FLCore)    # install.packages("FLCore", repos="http://flr-project.org/R")
library(FLBRP)     # install.packages("FLBRP", repos="http://flr-project.org/R")
library(FLasher)   # install.packages("FLasher", repos="http://flr-project.org/R")
library(FLAssess)  # install.packages("FLAssess", repos="http://flr-project.org/R")
library(FLife)     # install.packages("FLife", repos="http://flr-project.org/R")
library(ggplotFL)

library(popbio)

library(GGally)
library(ggpubr)

library(rjson) # install.packages("rjson"); used for dropbox function
library(RJSONIO)

library(plyr)
library(dplyr)
library(reshape)

library(readxl)
  
library(mgcv)
library(mgcViz)

library(tidyverse)

theme_set(theme_bw(16))

library(captioner)     # captions
tab_nums <- captioner::captioner(prefix = "Table", levels=3, type=c("n","n","n"), infix=".")
fig_nums <- captioner::captioner(prefix = "Figure", levels=3, type=c("n","n","n"), infix=".")

source("../R/dd.R")
source("../R/get_dropbox.r")
source("../R/pm.R")

dropboxdir<-try(file.path(get_dropbox(), "pelagics"))

if ("try-error"%in%is(dropboxdir))
  dropboxdir="~/Dropbox/pelagics"


mystk     <- "mac"; mystkname <- "Northeast Atlantic mackerel"; mylatin <- "Scombrus scomber"
# mystk     <- "whb"; mystkname <- "Blue whiting";                mylatin <- "Micromesistius poutassou" 
maxyear <- 2050


# ------------------------------------------------------------------------------
# Operating model
# ------------------------------------------------------------------------------
resultsdir <- file.path(dropboxdir, "results", mystk, "figures")


```

<!-- ## Mackerel report -->


**Evaluating impacts of Density Dependent processes on `r mystkname` via MSE simulations**


**L. Kell, M.A. Pastoors**

`r format(Sys.time(), '%d/%m/%Y')`

Commissioned by: University of Copenhagen (Henrik Sparholt)

# Executive summary

[summary here]

# Introduction

The purpose of this work is to support the project “Fmsy-project for six high profile fish stocks”. The project focuses on the current management approach for fish stocks based on single-species Fmsy Values where the only density-dependent process that is included is recruitment. The project includes three other density-dependent population dynamics: growth (weight at age), sexual maturity and natural mortality.  

This report deals with the evaluation of density dependent processes for `r mystkname` using Management Strategy Evaluation (MSE). Four alternatives MSE's have been included: 

1. No density dependent processes
2. DD in growth
3. DD in growth and maturity
4. DD in growth, maturity and natural mortality

All MSE's have been developed within the FLR framework [ref] and all the code is stored on github [ref]. 

All data and results are available on DropBox [ref]

# On density-dependent processes

Life history parameters are used to develop an example of modelling density dependence for mass, maturity and natural mortality-at-age. The parameters are first used to construct An `FLBRP` object representing the equilibrium, and are then coerced into an `FLStock` to model the time series dynamics.

## Mass-at-age [SHOULD WE CALL IT WEIGHT AT AGE, SINCE WE ARE USING Wa? ]

Mass-at-age ($W_a$) is modelled as

$W_a = {\overline{W_a}} B^{{\beta}_a}$

Where $\overline{W_a}$ and $\beta$ are estimated from a regression of mass-at-age ($W_a$) on total biomass ($B_a$), based on empirical data. $W_a$ is constrained so sizes do not become unfeasible large or small.

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_dd_mass", level = 1, display = FALSE,
  caption = "Simulation of density dependence in mass-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(resultsdir, paste0(mystk,"_sim_dd_mass.jpg")))

```

_`r fig_nums("sim_dd_mass")`_

## Maturity-at-weight

Maturity is then  modelled as a logistic function of mass-at-age i.e.

$O(W_a) = 1/(1+e^{k(W_a-W_{50})})$

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_dd_mat", level = 1, display = FALSE,
  caption = "Simulation of density dependence in maturity-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(resultsdir, paste0(mystk,"_sim_dd_maturity.jpg")))

```

_`r fig_nums("sim_dd_mat")`_


## Natural mortality

Is assumed to vary at unit length ($L_1$) e.g.

$ln(M_1) =\alpha + \beta ln(L_{\infty}) + \gamma ln(k)$

where $\alpha=0.65$, $\beta=0.91$, $\gamma=0.87$

Length-at-age ($L_a$) can be obtained from the length-weight relationship

$L_a=(W/a)^{1/b}$

giving

$ln(M_1) =(W/a)^{1/b}(\alpha + \beta ln(L_{\infty}) + \gamma ln(k))$

For DD there is a relationship between Mass at age $M_a$ and total biomass ($B$)

Mackerel:

$M = 0.0232B + 0.0524$

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_dd_m", level = 1, display = FALSE,
  caption = "Simulation of density dependence in M-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(resultsdir, paste0(mystk,"_sim_dd_m.jpg")))

```

_`r fig_nums("sim_dd_m")`_

Comparison of equilibrium yield plots for simulation with and without density-dependent processes

```{r, echo=FALSE, fig.width=0.6, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

fig_nums(
  name    = "sim_yield", level = 1, display = FALSE,
  caption = "Simulation of density dependence in M-at-age for different levels of biomass relative to Bmsy")

knitr::include_graphics(path=file.path(resultsdir, paste0(mystk,"_sim_dd_m.jpg")))

```

_`r fig_nums("sim_dd_m")`_


# OM conditioning

Stock assessments with SAM (non-DD), density-dependent SAM, VPA based on SAM (non-DD) and density-dependent VPA. The VPA reconstructions of the SAM assessment, shows a strongly divergent pattern in recruitment and also some differences in the trend of SSB. Mean fishing mortality is somewhat more variable in the VPA reconstruction compared to the SAM assessment. Density-dependent processes (on weight, maturity and M) tend to lead to lower SSB in the latter part of the time series. 


```{r, echo=FALSE, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

knitr::include_graphics(path=file.path(resultsdir, paste0(mystk,"_om.jpg")))

```

\newpage

Forward projections with F=fmsy (fwd), 0.8xfmsy?, 1.0xfmsy, 1.2xfmsy?

```{r, mac.data2, echo=FALSE, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

# sr=fmle(as.FLSR(om,model="bevholt"),control=list(silent=TRUE))
# eq=FLBRP(om,sr=sr)
# 
# om=fwdWindow(om,end=maxyear,eq)
# f =fbar(om)[,ac(2021:maxyear)]%=%refpts(eq)["msy","harvest"]
# om=fwd(om,fbar=f,sr=eq)
# 
# om2=om
# om3=om
# om4=om
# 
# for (iYear in ac(2021:maxyear)){
#   om2=ddFn(iYear,om2,par)
#   om2=fwd(om2,fbar=f[,iYear]*0.8,sr=eq)
# 
#   om3=ddFn(iYear,om3,par)
#   om3=fwd(om3,fbar=f[,iYear],sr=eq)
#   
#   om4=ddFn(iYear,om4,par)
#   om4=fwd(om4,fbar=f[,iYear]*1.2,sr=eq)
#   }
# 
# plot(FLStocks("fwd"=om,"0.8"=om2,"1.0"=om3,"1.2"=om4))

```

# Simulation results

# Discussion and conclusions

The quality shall live up to that demanded by the International Council for the Exploration of the Sea (ICES) and potentially be used in ICES advice to fisheries managers. The Consultant shall be interacting with the leadership of the project Henrik Sparholt, or his representative, in the process of developing the software. The software shall be made publicly available via Github or on alternative platform if so directed by Henrik Sparholt or his representative.

# Funding

# References

# Annex 1: OM conditioning

# Annex 2: Density dependent processes



