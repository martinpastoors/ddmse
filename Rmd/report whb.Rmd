---
output:
  word_document:
    reference_docx: ../report_template.dotx
mathjax: TRUE
---


```{r, knitr, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}
library(knitr)

knitr::opts_chunk$set(
               cache     =TRUE, 
               comment   ="", 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE, 
               eval      =TRUE,
               crop      =TRUE,
               cache.path="../cache/figs/cond/",
               fig.path  ="../tex/figs",
               fig.width =10,
               fig.height=8,
               dev       ="png")

rm(list=ls())

iFig=0
iTab=0

library(FLCore)    # install.packages("FLCore", repos="http://flr-project.org/R")
library(FLBRP)     # install.packages("FLBRP", repos="http://flr-project.org/R")
library(FLasher)   # install.packages("FLasher", repos="http://flr-project.org/R")
library(FLAssess)  # install.packages("FLAssess", repos="http://flr-project.org/R")
library(FLife)     # install.packages("FLife", repos="http://flr-project.org/R")
library(ggplotFL)

library(popbio)

library(GGally)
library(ggpubr)

library(rjson) # install.packages("rjson"); used for dropbox function
library(RJSONIO)

library(plyr)
library(dplyr)
library(reshape)

library(readxl)
  
library(mgcv)
library(mgcViz)

library(tidyverse)

theme_set(theme_bw(16))

source("../R/dd.R")
source("../R/get_dropbox.r")
source("../R/pm.R")

dropboxdir<-try(file.path(get_dropbox(), "pelagics"))

if ("try-error"%in%is(dropboxdir))
  dropboxdir="~/Dropbox/pelagics"


# mystk     <- "whb"; mystkname <- "Blue whiting"
# mystk     <- "her"; mystkname <- "North Sea herring"
mystk     <- "mac"; mystkname <- "Northeast Atlantic mackerel"; maxyear <- 2050


```

# Evaluating impacts of Density Dependent processes on `r mystkname` MSE

**L. Kell, M.A. Pastoors

`r format(Sys.time(), '%d/%m/%Y')`

## Introduction

## OM conditioning

Stock assessments with SAM, Density dependent SAM and Density dependent VPA

```{r, mac.data, echo=FALSE, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

load(file.path(dropboxdir,"data/om/mac.RData"))
combY <- as.data.frame(pmYear(window(mac, start=2001)),drop=T) %>% mutate(stk=mystk, type="SAM") 

par=FLPar(c(m1=0.15/(0.2^-0.288),m2=-0.28,bmsy=3500000,b=0.3,k=30.1, w50=0.2)) 

stock.wt(   mac)[1]=0.01
catch.wt(   mac)[1]=0.01
landings.wt(mac)[1]=0.01
discards.wt(mac)[1]=0.01

om_orig=ddFn2(mac,par); 
combY <- bind_rows(combY,
                   as.data.frame(pmYear(window(om_orig, start=2001)),drop=T) %>% mutate(stk=mystk, type="DD SAM")) 

om=om_orig+VPA(om_orig)
om=ddFn2(om,par)
combY <- bind_rows(combY, 
                   as.data.frame(pmYear(window(om, start=2001)),drop=T) %>% mutate(stk=mystk, type="DD VPA") )

combY %>% 
  filter(qname %in% c("catch","ssb","rec","fbar")) %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  geom_ribbon(aes(fill=type, ymin=lowq, ymax=uppq, xmin=year, xmax=year), alpha=0.3) +
  geom_line(aes(colour=type)) +
  facet_grid(qname~., scales="free_y") 

```

\newpage

Forward projections with F=fmsy (fwd), 0.8xfmsy?, 1.0xfmsy, 1.2xfmsy?

```{r, mac.data2, echo=FALSE, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

sr=fmle(as.FLSR(om,model="bevholt"),control=list(silent=TRUE))
eq=FLBRP(om,sr=sr)

om=fwdWindow(om,end=maxyear,eq)
f =fbar(om)[,ac(2021:maxyear)]%=%refpts(eq)["msy","harvest"]
om=fwd(om,fbar=f,sr=eq)

om2=om
om3=om
om4=om

for (iYear in ac(2021:maxyear)){
  om2=ddFn(iYear,om2,par)
  om2=fwd(om2,fbar=f[,iYear]*0.8,sr=eq)

  om3=ddFn(iYear,om3,par)
  om3=fwd(om3,fbar=f[,iYear],sr=eq)
  
  om4=ddFn(iYear,om4,par)
  om4=fwd(om4,fbar=f[,iYear]*1.2,sr=eq)
  }

plot(FLStocks("fwd"=om,"0.8"=om2,"1.0"=om3,"1.2"=om4))

```

## Simulation results

## Discussion and conclusions




ICES
Fmsy
HCR1 (no bounds)

```{r, runWhb1, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

myvar     <- c("catch","cCum", "ssb","fbar", "rec")
scenarios <- c("ICES", "Fmsy", "HCR1")
rp        <- refs  %>% 
  filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger")) %>% 
  mutate(qname = factor(qname, levels=myvar))
ices      <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% 
  dplyr::select(- .id) %>% 
  mutate(qname = factor(qname, levels=myvar))
df        <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(qname = factor(qname, levels=myvar))
iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 5) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(stk, .id, iter) %>% 
  mutate(perc_diff = (data-lag(data))/lag(data)) 
# box <- 
#   bind_rows(
#     df   %>% dplyr::select(.id, qname, stk, data=median),
#     ices %>% dplyr::select(qname, stk, data=median) %>% mutate(.id="ICES")
#   ) %>% 
#   group_by(qname, stk) %>% 
#   summarise(max = max(data, na.rm=TRUE), min = min(data, na.rm=TRUE)) %>% 
#   mutate(min = ifelse(min<0, min, 0)) %>% 
  
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  # vline at 2010
  geom_vline(xintercept = 2010, colour="darkgray", linewidth=1) +
  
  # iters
  geom_line(data=iters,
            aes(y=data, group=iter),
            linewidth=0.4, colour="darkgray") +
  
  # median and ribbon
  geom_line(aes(y=median),
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq),
              alpha=0.2, fill="red") +
  
  # ICES
  geom_line(data= ices,
            aes(year,median),
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp,
            aes(x=year, y=data, group=reftype, col=reftype, linetype=reftype),
            linewidth=1) +
  scale_linetype_manual(values = c("longdash","dashed"), breaks = c("lim", "msy") ) +
  scale_colour_manual  (values = c("black","darkgray"), breaks = c("lim", "msy") ) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")



```

**Figure `r mystk`.2**  `r mystkname`. Comparison of different HCR’s without TAC bounds

\newpage

#### `r mystkname`: comparing different HCR’s with and without TAC bounds

Fmsy
HCR0 (no bounds)
HCR1 bnd (-25%/+20% TAC change bounds apply when stock is above MSY Btrigger)
HCR2 bnd (-25%/+20% TAC change bounds apply when stock is above Blim)

```{r, runWhb2, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

myvar     <- c("catch","cCum", "ssb","fbar")
scenarios <- c("Fmsy", "HCR1",  "HCR1 bnd", "HCR2 bnd")
rp        <- refs %>% 
  filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger")) %>% 
    mutate(qname = factor(qname, levels=myvar))
ices      <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% 
  dplyr::select(- .id) %>% 
  mutate(qname = factor(qname, levels=myvar))
df        <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(qname = factor(qname, levels=myvar))
iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 5) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(stk, .id, iter) %>% 
  mutate(perc_diff = (data-lag(data))/lag(data)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  # vline at 2010
  geom_vline(xintercept = 2010, colour="darkgray", linewidth=1) +
  
  # iters
  geom_line(data=iters,
            aes(y=data, group=iter),
            linewidth=0.4, colour="darkgray") +
  
  # median and ribbon
  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype, linetype=reftype),
            linewidth=1) +
  scale_linetype_manual(values = c("longdash","dashed"), breaks = c("lim", "msy") ) +
  scale_colour_manual  (values = c("black","darkgray"), breaks = c("lim", "msy") ) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")



```

**Figure `r mystk`.3**  `r mystkname`. Comparison of different HCR’s with and without TAC bounds

\newpage

#### `r mystkname`: comparing HCR’s with and without a cap on TAC bounds

HCR1 bnd
HCR1 bnd cap
HCR2 bnd
HCR2 bnd cap

```{r, runWhb3, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}


myvar     <- c("catch","cCum", "ssb","fbar")
scenarios <- c("HCR1 bnd", "HCR1 bnd cap", "HCR2 bnd", "HCR2 bnd cap")
rp        <- refs %>% 
  filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger")) %>% 
    mutate(qname = factor(qname, levels=myvar))
ices      <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% 
  dplyr::select(- .id) %>% 
  mutate(qname = factor(qname, levels=myvar))
df        <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(qname = factor(qname, levels=myvar))
iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 5) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(stk, .id, iter) %>% 
  mutate(perc_diff = (data-lag(data))/lag(data)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  # vline at 2010
  geom_vline(xintercept = 2010, colour="darkgray", linewidth=1) +

  # iters
  geom_line(data=iters,
            aes(y=data, group=iter),
            linewidth=0.4, colour="darkgray") +
  
  # median and ribbon
  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype, linetype=reftype),
            linewidth=1) +
  scale_linetype_manual(values = c("longdash","dashed"), breaks = c("lim", "msy") ) +
  scale_colour_manual  (values = c("black","darkgray"), breaks = c("lim", "msy") ) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")

```

**Figure `r mystk`.4**  `r mystkname`. Comparison of different HCR’s with and without a cap on TAC bounds

\newpage

#### `r mystkname`: comparing HCR’s with and without implementation error (without bounds on TAC change)

HCR0
HCR1 10%
HCR1 20%
HCR1 30%
HCR1 10% recent
HCR1 10% random recent


```{r, runWhb4, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}


myvar     <- c("catch","cCum", "ssb","fbar")
scenarios <- c("HCR1", "HCR1 +10%", "HCR1 +20%", "HCR1 +30%", "HCR1 +10% recent", 
               "HCR1 +random recent")
rp        <- refs %>% 
  filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger")) %>% 
  mutate(qname = factor(qname, levels=myvar))
ices      <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% 
  dplyr::select(- .id) %>% 
  mutate(qname = factor(qname, levels=myvar))
df        <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(qname = factor(qname, levels=myvar))
iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 5) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(stk, .id, iter) %>% 
  mutate(perc_diff = (data-lag(data))/lag(data)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+
  
  # vline at 2010
  geom_vline(xintercept = 2010, colour="darkgray", linewidth=1) +

  # iters
  geom_line(data=iters,
            aes(y=data, group=iter),
            linewidth=0.4, colour="darkgray") +
  
  # median and ribbon
  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype, linetype=reftype),
            linewidth=1) +
  scale_linetype_manual(values = c("longdash","dashed"), breaks = c("lim", "msy") ) +
  scale_colour_manual  (values = c("black","darkgray"), breaks = c("lim", "msy") ) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")

```

**Figure `r mystk`.5**  `r mystkname`. Comparison of different HCR’s with and without implementation error (without bounds on TAC change)

\newpage

#### `r mystkname`: comparing HCR’s with and without implementation error in combination with bounds on TAC change

HCR1 bnd
HCR1 10% bnd
HCR1 10% recent bnd
HCR1 10% random bnd
HCR1 10% random recent bnd

```{r, runWhb5, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}


myvar     <- c("catch","cCum", "ssb","fbar")
scenarios <- c("HCR1 bnd", 
               "HCR1 +10% bnd",
               "HCR1 +10% bnd recent",
               "HCR1 +random bnd", 
               "HCR1 +random bnd recent")
rp        <- refs %>% 
  filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger")) %>% 
  mutate(qname = factor(qname, levels=myvar))
ices      <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% 
  dplyr::select(- .id) %>% 
  mutate(qname = factor(qname, levels=myvar))
df        <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(qname = factor(qname, levels=myvar))
iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 5) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(stk, .id, iter) %>% 
  mutate(perc_diff = (data-lag(data))/lag(data)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+
  
  # vline at 2010
  geom_vline(xintercept = 2010, colour="darkgray", linewidth=1) +

  # iters
  geom_line(data=iters,
            aes(y=data, group=iter),
            linewidth=0.4, colour="darkgray") +
  
  # median and ribbon
  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype, linetype=reftype),
            linewidth=1) +
  scale_linetype_manual(values = c("longdash","dashed"), breaks = c("lim", "msy") ) +
  scale_colour_manual  (values = c("black","darkgray"), breaks = c("lim", "msy") ) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")

```

**Figure `r mystk`.6**  `r mystkname`. Comparison of different HCR’s with and without implementation error in combination with bounds on TAC change

\newpage

#### `r mystkname`: checking the working of different constraints

```{r, whbcheck, echo=FALSE, fig.asp=.5, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}


myvar     <- c("ssb")
# scenarios <- c("ICES", "HCR1 bnd", "HCR1 +10%", "HCR1 +10% bnd", "HCR1 +10% bnd cap")
scenarios <- c("HCR1", "HCR1 bnd", "HCR2", "HCR2 bnd")
#scenarios <- c("ICES", "HCR1 bnd", "HCR1 +10% bnd", "HCR1 +20% bnd", "HCR1 +30% bnd")
rp        <- refs %>% filter(stk == mystk, refpoint %in% c("msybtrigger", "blim"))
ices      <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% dplyr::select(- .id)
df        <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  left_join(dplyr::select(rp,
                          stk, year, qname, refpoint, reftype, rp=data), 
            by=c("stk", "year", "qname")) %>% 
  mutate(trigger = ifelse(median >= rp, "above","below"))
iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 10) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  left_join(dplyr::select(rp,
                          stk, year, qname, refpoint, reftype, rp=data), 
            by=c("stk", "year", "qname")) %>% 
  mutate(trigger = ifelse(data >= rp, "above","below"))
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+
  geom_line(data=iters,
            aes(y=data, group=iter),
            linewidth=0.4, colour="darkgray") +
  geom_point(data=filter(iters,
                         trigger=="above"),
            aes(y=data, group=iter),
            size=1.0, colour="black") +
  
  geom_line(linewidth=1, colour="red") +
  geom_point(data=filter(df,
                        trigger=="above"),
            colour="red", size=2) +
    # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype, linetype=reftype),
            linewidth=1) +
  scale_linetype_manual(values = c("longdash","dashed"), breaks = c("lim", "msy") ) +
  scale_colour_manual  (values = c("black","darkgray"), breaks = c("lim", "msy") ) +
  labs(y="ssb (tonnes)") +
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")



myvar     <- c("catch")
# scenarios <- c("ICES", "HCR1 bnd", "HCR1 +10%", "HCR1 +10% bnd", "HCR1 +10% bnd cap")
# scenarios <- c("ICES", "HCR1 bnd", "HCR1 +10% bnd", "HCR1 +20% bnd", "HCR1 +30% bnd")
rp        <- refs %>% 
  filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger")) %>% 
  mutate(qname = factor(qname, levels=myvar))
ices      <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% 
  dplyr::select(- .id) %>% 
  mutate(qname = factor(qname, levels=myvar))
df        <- combY %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(qname = factor(qname, levels=myvar)) %>% 
  group_by(stk, .id) %>% 
  mutate(perc_diff = (median-lag(median))/lag(median)) 

iters        <- combYI %>% 
  filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021, iter <= 5) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(stk, .id, iter) %>% 
  mutate(perc_diff = (data-lag(data))/lag(data)) 
  
df %>% 
  ggplot(aes(x=year, y=perc_diff)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  geom_line(data=iters,
            aes(x=year, y=perc_diff, group=iter),
            linewidth=.4, colour="darkgray", inherit.aes = FALSE) +
  
  geom_line(linewidth=1, colour="red") +
  
  geom_hline(yintercept = 0.25, colour="black", linewidth=1, linetype=2) +
  geom_hline(yintercept = -0.2, colour="black", linewidth=1, linetype=2) +
  expand_limits(y=0) +
  scale_y_continuous(labels=scales::percent, limits=c(-2,2)) +
  facet_grid(qname ~ .id, scales="free_y")





```

**Figure `r mystk`.6**  `r mystkname`. Comparison of the working of constraints on TAC change relative to stock size and reference point MSY Btrigger. Black dots indicate estimated stock size on individual runs above MSY Btrigger (i.e. TAC contstraint applies). Red dots indicate median stock size above MSY Btrigger. 

\newpage

#### `r mystkname`: comparing all scenario's on median catch, IAV and AAV

```{r, whbsmry, echo=FALSE, fig.asp=1.2, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}



myvar     <- c("catch.50", "iav.50", "aav")
scenarios <- c("ICES","Fmsy","HCR1","HCR1 bnd","HCR1 bnd cap", "HCR1 +10% bnd","HCR1 +10% bnd cap",
               "HCR1 +10% bnd recent","HCR1 +random bnd",",HCR1 +random bnd recent","HCR1 +10%",
               "HCR1 +10% recent","HCR1 +random","HCR1 +random recent","HCR1 +20% bnd", 
               "HCR1 +20% bnd cap","HCR1 +20% bnd recent","HCR1 +20%","HCR1 +20% recent",
               "HCR1 +30% bnd","HCR1 +30% bnd cap","HCR1 +30% bnd recent","HCR1 +30%",
               "HCR1 +30% recent",
               "HCR2","HCR2 bnd","HCR2 bnd cap","HCR2 +10% bnd","HCR2 +10% bnd cap",
               "HCR2 +10% bnd recent","HCR2 +random bnd","HCR2 +random bnd recent","HCR2 +10%",
               "HCR2 +10% recent","HCR2 +random","HCR2 +random recent","HCR2 +20% bnd",
               "HCR2 +20% bnd cap","HCR2 +20% bnd recent","HCR2 +20%","HCR2 +20% recent",
               "HCR2 +30% bnd","HCR2 +30% bnd cap","HCR2 +30% bnd recent","HCR2 +30%",
               "HCR2 +30% recent")

df        <- combI %>% 
  tidyr::pivot_longer(names_to = "variable", values_to = "data", myvar) %>% 
  filter(stk == mystk,  .id %in% scenarios) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(variable = factor(variable, levels=myvar))

calc_boxplot_stat <- function(x) {
  coef <- 1.5
  n <- sum(!is.na(x))
  # calculate quantiles
  stats <- quantile(x, probs = c(0.0, 0.25, 0.5, 0.75, 1.0))
  names(stats) <- c("ymin", "lower", "middle", "upper", "ymax")
  iqr <- diff(stats[c(2, 4)])
  # set whiskers
  outliers <- x < (stats[2] - coef * iqr) | x > (stats[4] + coef * iqr)
  if (any(outliers)) {
    stats[c(1, 5)] <- range(c(stats[2:4], x[!outliers]), na.rm = TRUE)
  }
  return(stats)
}

df %>% 
  ggplot(aes(x=.id, y=data)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +
  expand_limits(y=0) +
  # scale_y_continuous(limits = quantile(t$data, c(0.1, 0.9))) +
  labs(x="", y="") +
  facet_grid(variable~., scales="free", space="free_x")

```

**Figure `r mystk`.7**  `r mystkname`. Comparison of all scenario's on median catch, median IAV (Interannual variability in catch) and AAV (Average Annual Variability in catch)

```{r smry2, eval=FALSE, fig.align="center", fig.asp=1.2, message=FALSE, warning=FALSE, cache=FALSE, include=FALSE, whbsmry, echo=FALSE}

mystk     <- c("whb","her","mac")
myvar     <- c("catch.50", "iav.50", "aav")
scenarios <- c("ICES","Fmsy","HCR1","HCR1 bnd","HCR1 bnd cap", "HCR1 +10% bnd","HCR1 +10% bnd cap",
               "HCR1 +10% bnd recent","HCR1 +random bnd",",HCR1 +random bnd recent","HCR1 +10%",
               "HCR1 +10% recent","HCR1 +random","HCR1 +random recent","HCR1 +20% bnd", 
               "HCR1 +20% bnd cap","HCR1 +20% bnd recent","HCR1 +20%","HCR1 +20% recent",
               "HCR1 +30% bnd","HCR1 +30% bnd cap","HCR1 +30% bnd recent","HCR1 +30%",
               "HCR1 +30% recent",
               "HCR2","HCR2 bnd","HCR2 bnd cap","HCR2 +10% bnd","HCR2 +10% bnd cap",
               "HCR2 +10% bnd recent","HCR2 +random bnd","HCR2 +random bnd recent","HCR2 +10%",
               "HCR2 +10% recent","HCR2 +random","HCR2 +random recent","HCR2 +20% bnd",
               "HCR2 +20% bnd cap","HCR2 +20% bnd recent","HCR2 +20%","HCR2 +20% recent",
               "HCR2 +30% bnd","HCR2 +30% bnd cap","HCR2 +30% bnd recent","HCR2 +30%",
               "HCR2 +30% recent")

df        <- combI %>% 
  tidyr::pivot_longer(names_to = "variable", values_to = "data", myvar) %>% 
  filter(stk %in% mystk,  .id %in% scenarios) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  mutate(variable = factor(variable, levels=myvar)) %>% 
  mutate(stk = factor(stk, levels=mystk))


calc_boxplot_stat <- function(x) {
  coef <- 1.5
  n <- sum(!is.na(x))
  # calculate quantiles
  stats <- quantile(x, probs = c(0.0, 0.25, 0.5, 0.75, 1.0))
  names(stats) <- c("ymin", "lower", "middle", "upper", "ymax")
  iqr <- diff(stats[c(2, 4)])
  # set whiskers
  outliers <- x < (stats[2] - coef * iqr) | x > (stats[4] + coef * iqr)
  if (any(outliers)) {
    stats[c(1, 5)] <- range(c(stats[2:4], x[!outliers]), na.rm = TRUE)
  }
  return(stats)
}

df %>% 
  ggplot(aes(x=.id, y=data)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +
  expand_limits(y=0) +
  # scale_y_continuous(limits = quantile(t$data, c(0.1, 0.9))) +
  labs(x="", y="") +
  facet_grid(variable~stk, scales="free", space="free_x")

```
